# Enable Rewrite Engine
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /DailyCup/

# Ignore favicon.ico - prevent 404 errors
RewriteRule ^favicon\.ico$ - [L,NC,R=204]
    
# Force HTTPS (uncomment for production)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
# Prevent directory listing
Options -Indexes
    
# Protect sensitive files (using RewriteRule for compatibility)
# .env, .htaccess, config files already protected by RewriteRule below
    
# Protect .git directory
RedirectMatch 404 /\.git
    
# Block common exploit attempts
RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK|OPTIONS)$ [NC]
RewriteRule ^.*$ - [F,L]

# Block access to backup and source files
RewriteRule \.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|sw[op])$ - [F,L]

# Block access to sensitive files and directories
RewriteRule ^\.env$ - [F,L]
RewriteRule ^\.htaccess$ - [F,L]
RewriteRule ^\.htpasswd$ - [F,L]
RewriteRule ^\.git - [F,L]
RewriteRule ^composer\.(json|lock)$ - [F,L]
RewriteRule ^database/.*\.sql$ - [F,L]
RewriteRule ^config/(oauth_config|database|constants)\.(php|example|local)$ - [F,L]
RewriteRule ^phpinfo\.php$ - [F,L]
    
<IfModule mod_headers.c>
  # Clickjacking protection
  Header always set X-Frame-Options "SAMEORIGIN"

  # XSS Protection (deprecated, removed)

  # Referrer Policy
  Header always set Referrer-Policy "strict-origin-when-cross-origin"

  # Permissions Policy (formerly Feature-Policy)
  Header always set Permissions-Policy "geolocation=(self), microphone=(), camera=(), payment=(self)"

  # Content Security Policy (adjust based on your needs)
  # Patched to allow jsdelivr, unpkg for Leaflet maps, and source maps
  Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://code.jquery.com https://maps.googleapis.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com https://unpkg.com; img-src 'self' data: https: blob:; font-src 'self' https://cdn.jsdelivr.net https://fonts.gstatic.com; connect-src 'self' https://maps.googleapis.com https://cdn.jsdelivr.net; frame-src 'self' https://www.google.com;"

  # HSTS - HTTP Strict Transport Security (enable after HTTPS is configured)
  # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

  # Remove server signature
  Header unset Server
  Header unset X-Powered-By
</IfModule>

# PHP Configuration
<IfModule mod_php.c>
php_value upload_max_filesize 10M
php_value post_max_size 10M
php_value max_execution_time 300
php_value max_input_time 300
php_flag display_errors Off
php_value error_reporting 0
</IfModule>

# Custom Error Pages (optional)
# ErrorDocument 404 /dailycup/error/404.php
# ErrorDocument 500 /dailycup/error/500.php

# Cache Control for Static Assets
<IfModule mod_expires.c>
ExpiresActive On
ExpiresByType image/jpg "access plus 1 year"
ExpiresByType image/jpeg "access plus 1 year"
ExpiresByType image/gif "access plus 1 year"
ExpiresByType image/png "access plus 1 year"
ExpiresByType text/css "access plus 1 month"
ExpiresByType application/javascript "access plus 1 month"
ExpiresByType application/x-javascript "access plus 1 month"
ExpiresByType image/x-icon "access plus 1 year"
</IfModule>

# Compression
<IfModule mod_deflate.c>
AddOutputFilterByType DEFLATE text/html
AddOutputFilterByType DEFLATE text/css
AddOutputFilterByType DEFLATE text/javascript
AddOutputFilterByType DEFLATE text/xml
AddOutputFilterByType DEFLATE text/plain
AddOutputFilterByType DEFLATE image/x-icon
AddOutputFilterByType DEFLATE image/svg+xml
AddOutputFilterByType DEFLATE application/rss+xml
AddOutputFilterByType DEFLATE application/javascript
AddOutputFilterByType DEFLATE application/x-javascript
AddOutputFilterByType DEFLATE application/xml
AddOutputFilterByType DEFLATE application/xhtml+xml
AddOutputFilterByType DEFLATE application/x-font
AddOutputFilterByType DEFLATE application/x-font-truetype
AddOutputFilterByType DEFLATE application/x-font-ttf
AddOutputFilterByType DEFLATE application/x-font-otf
AddOutputFilterByType DEFLATE application/x-font-opentype
AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
AddOutputFilterByType DEFLATE font/ttf
AddOutputFilterByType DEFLATE font/otf
AddOutputFilterByType DEFLATE font/opentype
</IfModule>

# VirtualHost blocks removed from .htaccess â€” site-specific VirtualHost config belongs in Apache's httpd-vhosts.conf
# If you need environment variables for the backend, add them to backend/api/.htaccess or configure in VirtualHost in httpd-vhosts.conf.

